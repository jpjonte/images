name: Build Docker images

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      flutter_version:
        description: 'Flutter version to build (e.g. 3.41.1). Tags as both stable and version. Leave empty to build stable only.'
        required: false

permissions:
  packages: write

env:
  REGISTRY: ghcr.io
  NAMESPACE: ghcr.io/jpjonte

jobs:
  # ── Detect changed paths (push only) ─────────────────────────────
  changes:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      flutter: ${{ steps.filter.outputs.flutter }}
      php-8_4: ${{ steps.filter.outputs.php-8_4 }}
      php-8_5: ${{ steps.filter.outputs.php-8_5 }}
      kubectl: ${{ steps.filter.outputs.kubectl }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            flutter:
              - 'flutter/**'
            php-8_4:
              - 'php/8.4/**'
              - 'php/scripts/**'
            php-8_5:
              - 'php/8.5/**'
              - 'php/scripts/**'
            kubectl:
              - 'kubectl/**'

  # ── Check for new Flutter stable version (schedule only) ─────────
  check-flutter:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      build: ${{ steps.check.outputs.build }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Check latest Flutter stable version
        id: check
        run: |
          VERSION=$(curl -s https://storage.googleapis.com/flutter_infra_release/releases/releases_linux.json \
            | jq -r '.current_release.stable as $h | .releases[] | select(.hash==$h) | .version')
          echo "Latest stable Flutter version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          if docker manifest inspect ${{ env.NAMESPACE }}/flutter:$VERSION > /dev/null 2>&1; then
            echo "Flutter $VERSION already exists in GHCR"
            echo "build=false" >> "$GITHUB_OUTPUT"
          else
            echo "New Flutter version: $VERSION"
            echo "build=true" >> "$GITHUB_OUTPUT"
          fi
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled

  # ── Flutter ──────────────────────────────────────────────────────
  build-flutter:
    needs: [changes, check-flutter]
    if: |
      always() && (
        (github.event_name == 'push' && needs.changes.outputs.flutter == 'true') ||
        (github.event_name == 'schedule' && needs.check-flutter.outputs.build == 'true') ||
        github.event_name == 'workflow_dispatch'
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Determine tags
        id: tags
        run: |
          TAGS="${{ env.NAMESPACE }}/flutter:stable"
          VERSION="${{ needs.check-flutter.outputs.version || inputs.flutter_version }}"
          if [[ -n "$VERSION" ]]; then
            TAGS="${TAGS},${{ env.NAMESPACE }}/flutter:${VERSION}"
          fi
          echo "tags=$TAGS" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION:-stable}" >> "$GITHUB_OUTPUT"
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: flutter/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            FLUTTER_VERSION=${{ steps.tags.outputs.version }}

  # ── PHP ──────────────────────────────────────────────────────────
  build-php:
    needs: [changes]
    if: |
      always() && (
        (github.event_name == 'push' && (needs.changes.outputs.php-8_4 == 'true' || needs.changes.outputs.php-8_5 == 'true')) ||
        github.event_name == 'workflow_dispatch'
      )
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ['8.4', '8.5']
        exclude:
          - version: ${{ github.event_name == 'push' && needs.changes.outputs.php-8_4 != 'true' && '8.4' || 'never' }}
          - version: ${{ github.event_name == 'push' && needs.changes.outputs.php-8_5 != 'true' && '8.5' || 'never' }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: php/${{ matrix.version }}/Dockerfile
          push: true
          tags: ${{ env.NAMESPACE }}/php:${{ matrix.version }}

  # ── kubectl ──────────────────────────────────────────────────────
  build-kubectl:
    needs: [changes]
    if: |
      always() && (
        (github.event_name == 'push' && needs.changes.outputs.kubectl == 'true') ||
        github.event_name == 'workflow_dispatch'
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: kubectl/Dockerfile
          push: true
          tags: ${{ env.NAMESPACE }}/kubectl:stable
