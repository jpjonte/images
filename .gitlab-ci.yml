stages:
  - check
  - build

image:
  name: ghcr.io/osscontainertools/kaniko:v1.26.5-debug
  entrypoint: [""]

variables:
  BASE_NAMESPACE: ${REGISTRY_URL}

before_script:
  - scripts/login.sh

# ── Nightly version check ────────────────────────────────────────
check:flutter:
  stage: check
  image: alpine:3.21
  before_script: []
  script:
    - apk add --no-cache curl jq
    - sh flutter/check_version.sh
  artifacts:
    reports:
      dotenv: flutter_version.env
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

# ── PHP ──────────────────────────────────────────────────────────
build:php:8.2:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/php
    TAGS: "8.2"
    DOCKERFILE: php/8.2/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null'
      changes:
        - php/8.2/**/*
        - php/scripts/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true

build:php:8.3:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/php
    TAGS: "8.3"
    DOCKERFILE: php/8.3/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null'
      changes:
        - php/8.3/**/*
        - php/scripts/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true

build:php:8.5:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/php
    TAGS: "8.5"
    DOCKERFILE: php/8.5/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null'
      changes:
        - php/8.5/**/*
        - php/scripts/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true

# ── Flutter ──────────────────────────────────────────────────────
build:flutter:nightly:
  stage: build
  needs: [check:flutter]
  variables:
    DOCKERFILE: flutter/Dockerfile
  script:
    - test "$FLUTTER_BUILD" = "true" || exit 0
    - export NAMESPACE="${BASE_NAMESPACE}/flutter"
    - export TAGS="stable $FLUTTER_VERSION"
    - export BUILD_ARGS="--build-arg FLUTTER_VERSION=$FLUTTER_VERSION"
    - scripts/login.sh
    - scripts/build.sh
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

build:flutter:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/flutter
    TAGS: stable
    DOCKERFILE: flutter/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule" && ($CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null)'
      changes:
        - flutter/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true

# ── kubectl ──────────────────────────────────────────────────────
build:kubectl:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/kubectl
    TAGS: stable
    DOCKERFILE: kubectl/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null'
      changes:
        - kubectl/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true
