stages:
  - build

image:
  name: gcr.io/kaniko-project/executor:v1.9.0-debug
  entrypoint: [""]

variables:
  BASE_NAMESPACE: ${REGISTRY_URL}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}

before_script:
  - scripts/login.sh

build:php:8.2:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/php
    TAGS: "8.2"
    DOCKERFILE: php/8.2/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null'
      changes:
        - php/8.2/**/*
        - php/scripts/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true

build:php:8.3:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/php
    TAGS: "8.3"
    DOCKERFILE: php/8.3/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null'
      changes:
        - php/8.3/**/*
        - php/scripts/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true

build:php:8.5:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/php
    TAGS: "8.5"
    DOCKERFILE: php/8.5/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null'
      changes:
        - php/8.5/**/*
        - php/scripts/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true

build:flutter:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/flutter
    TAGS: stable
    DOCKERFILE: flutter/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null'
      changes:
        - flutter/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true

build:kubectl:
  stage: build
  variables:
    NAMESPACE: ${BASE_NAMESPACE}/kubectl
    TAGS: stable
    DOCKERFILE: kubectl/Dockerfile
  script:
    - scripts/build.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_TAG != null'
      changes:
        - kubectl/**/*
        - scripts/**/*
    - when: manual
      allow_failure: true
